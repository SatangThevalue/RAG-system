version: "3.9"
services:
  api:
    build: ./api
    container_name: rag_api
    env_file: .env
    ports: ["8000:8000"]
    depends_on:
      - chroma
      - redis
      - postgres
    volumes:
      - ./data/docs:/app/data/docs:ro
    command: uvicorn app:app --host 0.0.0.0 --port 8000

  chroma:
    image: chromadb/chroma:latest
    container_name: rag_chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    volumes: [chroma_data:/chroma/chroma]
    ports: ["8001:8000"]

  langflow:
    image: langflowai/langflow:latest
    container_name: rag_langflow
    environment:
      - LANGFLOW_DATABASE_URL=${LANGFLOW_DATABASE_URL}
      - SECRET_KEY=${LANGFLOW_SECRET_KEY}
      - LANGFLOW_AUTO_CREATE_ADMIN=true
      - LANGFLOW_SUPERUSER=${LANGFLOW_SUPERUSER}
      - LANGFLOW_SUPERUSER_PASSWORD=${LANGFLOW_SUPERUSER_PASSWORD}
    ports: ["7860:7860"]
    depends_on:
      postgres:
        condition: service_healthy
    command: bash -lc "python -m langflow run --host 0.0.0.0 --port 7860"

  redis:
    image: redis:7-alpine
    container_name: rag_redis
    ports: ["6379:6379"]
    command: ["redis-server", "--appendonly", "yes"]
    volumes: [redis_data:/data]

  postgres:
    image: postgres:16-alpine
    container_name: rag_postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports: ["5432:5432"]
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20

  adminer:
    image: adminer:latest
    container_name: rag_adminer
    ports: ["8082:8080"]
    depends_on:
      - postgres

  redis_commander:
    image: rediscommander/redis-commander:latest
    container_name: rag_redis_cmd
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports: ["8081:8081"]
    depends_on: [redis]

volumes:
  chroma_data:
  langflow_data:
  redis_data:
  pg_data: